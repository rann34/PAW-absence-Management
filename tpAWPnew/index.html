<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>TP AWP - Exo1 + Exo2 (Fusion)</title>
<style>
    :root{
        --beige:#F5ECE0;
        --marron:#6B4C3B;
        --accent:#B78A6D;
        --text:#3a2f2a;
        --muted:#7a6a60;
        --white:#fff;
    }
    body{
        background: linear-gradient(180deg, var(--beige), #efe7db);
        color:var(--text);
        font-family: "Segoe UI", Roboto, Arial, sans-serif;
        padding:24px;
    }
    h1,h2{ color:var(--marron); margin-bottom:6px; }
    .container{ max-width:1100px; margin:0 auto; background:rgba(255,255,255,0.6); padding:18px; border-radius:12px; box-shadow:0 6px 18px rgba(107,76,59,0.12);}
    form{ display:flex; gap:12px; flex-wrap:wrap; align-items:end; margin-bottom:18px; }
    label{ font-size:14px; color:var(--marron); display:block; margin-bottom:4px;}
    input[type="text"], input[type="email"]{ padding:8px 10px; border-radius:6px; border:1px solid #d6c6bd; background:#fff; min-width:160px; }
    button{ background:var(--marron); color:var(--white); padding:8px 14px; border:none; border-radius:8px; cursor:pointer; box-shadow:0 2px 6px rgba(0,0,0,0.08); }
    button:disabled{ opacity:0.6; cursor:not-allowed; }
    .error{ color:#b00020; font-size:13px; margin-top:4px; min-height:16px;}
    table{ width:100%; border-collapse:collapse; margin-top:12px; font-size:14px; }
    th, td{ border:1px solid rgba(107,76,59,0.12); padding:6px 8px; text-align:center; vertical-align:middle; }
    th{ background:linear-gradient(90deg, rgba(183,138,109,0.15), rgba(183,138,109,0.05)); color:var(--marron); position:sticky; top:0; z-index:2;}
    .row-good{ background:linear-gradient(90deg, rgba(200,255,200,0.5), rgba(255,255,255,0)); }
    .row-warn{ background:linear-gradient(90deg, rgba(255,250,200,0.6), rgba(255,255,255,0)); }
    .row-bad{ background:linear-gradient(90deg, rgba(255,200,200,0.6), rgba(255,255,255,0)); }
    .small{ font-size:12px; color:var(--muted); }
    .controls{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .note{ margin-top:8px; font-size:13px; color:var(--muted); }
    .center{ text-align:center; }
    .checkbox-cell input{ transform:scale(1.1); }
    @media (max-width:980px){
        table{ font-size:12px; }
        input[type="text"]{ min-width:120px; }
    }
</style>
</head>
<body>
<div class="container">
    <h1>TP AWP — Présences & Formulaire d'ajout</h1>
    <p class="small">Format : modèle <strong>B</strong> — 2 colonnes par session (P = Présence, Pa = Participation). Le formulaire valide ID, noms et email avant ajout.</p>

    <h2>Ajouter un étudiant</h2>
    <form id="addForm" novalidate>
        <div>
            <label for="sid">Student ID</label>
            <input id="sid" name="sid" type="text" autocomplete="off">
            <div id="sidError" class="error"></div>
        </div>

        <div>
            <label for="lname">Last Name</label>
            <input id="lname" name="lname" type="text" autocomplete="off">
            <div id="lnameError" class="error"></div>
        </div>

        <div>
            <label for="fname">First Name</label>
            <input id="fname" name="fname" type="text" autocomplete="off">
            <div id="fnameError" class="error"></div>
        </div>

        <div>
            <label for="email">Email</label>
            <input id="email" name="email" type="email" autocomplete="off">
            <div id="emailError" class="error"></div>
        </div>

        <div class="controls">
            <button id="addBtn" type="submit">Add Student</button>
            <button id="resetBtn" type="button">Clear</button>
        </div>
    </form>

    <h2>Table d'assiduité</h2>
    <div style="overflow:auto">
    <table id="attendanceTable">
        <thead>
            <tr>
                <th rowspan="2">Student ID</th>
                <th rowspan="2">Last Name</th>
                <th rowspan="2">First Name</th>

                <!-- For 6 sessions: each session has 2 columns (P, Pa) -->
                <th colspan="2">S1</th>
                <th colspan="2">S2</th>
                <th colspan="2">S3</th>
                <th colspan="2">S4</th>
                <th colspan="2">S5</th>
                <th colspan="2">S6</th>

                <th rowspan="2">Absences</th>
                <th rowspan="2">Participations</th>
                <th rowspan="2">Message</th>
                <th rowspan="2">Actions</th>
            </tr>
            <tr>
                <!-- labels for P / Pa -->
                <th>P</th><th>Pa</th>
                <th>P</th><th>Pa</th>
                <th>P</th><th>Pa</th>
                <th>P</th><th>Pa</th>
                <th>P</th><th>Pa</th>
                <th>P</th><th>Pa</th>
            </tr>
        </thead>
        <tbody id="tableBody">
            <!-- rows ajoutées par JS (quelques exemples initiaux) -->
        </tbody>
    </table>
    </div>

    <p class="note">Astuce : coche/décoche les cases dans le tableau pour voir les calculs et la coloration s'appliquer en direct.</p>
</div>

<script>
(function(){
    // --- Configuration ---
    const SESSIONS = 6;
    let uniqueCounter = 0;

    // --- Helper : create sample initial students ---
    const initialStudents = [
        { sid: "1001", lname:"Ahmed", fname:"Sara", presences:[1,1,0,0,1,0], parts:[1,0,0,0,1,0] },
        { sid: "1002", lname:"Yacine", fname:"Ali", presences:[1,0,1,1,1,1], parts:[1,0,1,1,1,1] },
        { sid: "1003", lname:"Houcine", fname:"Rania", presences:[1,1,0,1,1,0], parts:[1,0,0,1,0,0] }
    ];

    const tableBody = document.getElementById('tableBody');

    // --- Validation (Exo 2) ---
    const addForm = document.getElementById('addForm');
    const sidInput = document.getElementById('sid');
    const lnameInput = document.getElementById('lname');
    const fnameInput = document.getElementById('fname');
    const emailInput = document.getElementById('email');

    const sidError = document.getElementById('sidError');
    const lnameError = document.getElementById('lnameError');
    const fnameError = document.getElementById('fnameError');
    const emailError = document.getElementById('emailError');

    function clearErrors(){
        sidError.textContent = "";
        lnameError.textContent = "";
        fnameError.textContent = "";
        emailError.textContent = "";
    }

    function validateForm(){
        clearErrors();
        let valid = true;
        const sid = sidInput.value.trim();
        const lname = lnameInput.value.trim();
        const fname = fnameInput.value.trim();
        const email = emailInput.value.trim();

        if(sid === "" || !/^[0-9]+$/.test(sid)){
            sidError.textContent = "Student ID doit contenir uniquement des chiffres";
            valid = false;
        }
        if(lname === "" || !/^[A-Za-zÀ-ÖØ-öø-ÿ'\- ]+$/.test(lname)){
            lnameError.textContent = "Nom doit contenir uniquement des lettres";
            valid = false;
        }
        if(fname === "" || !/^[A-Za-zÀ-ÖØ-öø-ÿ'\- ]+$/.test(fname)){
            fnameError.textContent = "Prénom doit contenir uniquement des lettres";
            valid = false;
        }
        if(email === "" || !/^[^@\s]+@[^@\s]+\.[^@\s]+$/.test(email)){
            emailError.textContent = "Format d'email invalide (ex: nom@exemple.com)";
            valid = false;
        }
        return valid;
    }

    // --- Table functions ---
    function makeCheckbox(id, checked = false){
        const cb = document.createElement('input');
        cb.type = 'checkbox';
        cb.id = id;
        cb.checked = !!checked;
        cb.classList.add('row-checkbox');
        return cb;
    }

    function addStudentRow(data){
        uniqueCounter++;
        const row = document.createElement('tr');

        // ID / names
        const tdSid = document.createElement('td'); tdSid.textContent = data.sid; row.appendChild(tdSid);
        const tdL = document.createElement('td'); tdL.textContent = data.lname; row.appendChild(tdL);
        const tdF = document.createElement('td'); tdF.textContent = data.fname; row.appendChild(tdF);

        // for each session: P then Pa
        const presences = data.presences || Array(SESSIONS).fill(0);
        const parts = data.parts || Array(SESSIONS).fill(0);
        for(let i=0;i<SESSIONS;i++){
            const idP = `p-${data.sid}-${uniqueCounter}-${i}`;
            const idPa = `pa-${data.sid}-${uniqueCounter}-${i}`;

            const tdP = document.createElement('td'); tdP.classList.add('checkbox-cell');
            const cbP = makeCheckbox(idP, !!presences[i]);
            tdP.appendChild(cbP);
            row.appendChild(tdP);

            const tdPa = document.createElement('td'); tdPa.classList.add('checkbox-cell');
            const cbPa = makeCheckbox(idPa, !!parts[i]);
            tdPa.appendChild(cbPa);
            row.appendChild(tdPa);

            // When any checkbox changes, update this row's stats
            cbP.addEventListener('change', ()=> updateRow(row));
            cbPa.addEventListener('change', ()=> updateRow(row));
        }

        // Absences cell
        const tdAbs = document.createElement('td');
        tdAbs.classList.add('absencesCell');
        tdAbs.textContent = '0';
        row.appendChild(tdAbs);

        // Participations cell
        const tdPar = document.createElement('td');
        tdPar.classList.add('partsCell');
        tdPar.textContent = '0';
        row.appendChild(tdPar);

        // Message cell
        const tdMsg = document.createElement('td');
        tdMsg.classList.add('msgCell');
        tdMsg.textContent = '';
        row.appendChild(tdMsg);

        // Actions cell (delete)
        const tdAct = document.createElement('td');
        const delBtn = document.createElement('button');
        delBtn.type = 'button';
        delBtn.textContent = 'Suppr';
        delBtn.style.background = 'transparent';
        delBtn.style.border = '1px solid var(--marron)';
        delBtn.style.color = 'var(--marron)';
        delBtn.style.padding = '4px 8px';
        delBtn.style.borderRadius = '6px';
        delBtn.addEventListener('click', ()=>{
            row.remove();
        });
        tdAct.appendChild(delBtn);
        row.appendChild(tdAct);

        // append and compute
        tableBody.appendChild(row);
        updateRow(row);
    }

    function updateRow(row){
        // Count presences and participations
        const checkboxes = row.querySelectorAll('input[type="checkbox"]');
        let presCount = 0;
        let partCount = 0;
        // checkboxes come in pairs P, Pa, P, Pa...
        for(let i=0;i<checkboxes.length;i+=2){
            const p = checkboxes[i];
            const pa = checkboxes[i+1];
            if(p && p.checked) presCount++;
            if(pa && pa.checked) partCount++;
        }
        const absences = SESSIONS - presCount;

        // update cells
        const absCell = row.querySelector('.absencesCell');
        const partCell = row.querySelector('.partsCell');
        const msgCell = row.querySelector('.msgCell');
        absCell.textContent = absences + (absences>1 ? ' Abs' : ' Abs');
        partCell.textContent = partCount + (partCount>1 ? ' Par' : ' Par');

        // choose coloring
        row.classList.remove('row-good','row-warn','row-bad');
        if(absences >= 5){
            row.classList.add('row-bad');
        } else if(absences >= 3 && absences <= 4){
            row.classList.add('row-warn');
        } else {
            row.classList.add('row-good');
        }

        // message logic (examples from PDF)
        let message = '';
        if(absences >= 5){
            message = "Excluded - too many absences - You need to participate more";
        } else if(absences >= 3){
            message = "Warning - attendance low - You need to participate more";
        } else {
            if(partCount >= 4) message = "Good attendance - Excellent participation";
            else message = "Good attendance - Participate more";
        }
        msgCell.textContent = message;
    }

    // --- Initialize table with sample students ---
    initialStudents.forEach(s => addStudentRow(s));

    // --- Form events ---
    addForm.addEventListener('submit', function(e){
        e.preventDefault();
        if(!validateForm()) return;

        // Build data structure for new student (defaults: all unchecked)
        const newStudent = {
            sid: sidInput.value.trim(),
            lname: lnameInput.value.trim(),
            fname: fnameInput.value.trim(),
            presences: Array(SESSIONS).fill(0),
            parts: Array(SESSIONS).fill(0)
        };

        addStudentRow(newStudent);

        // clear form
        addForm.reset();
        clearErrors();
        sidInput.focus();
    });

    document.getElementById('resetBtn').addEventListener('click', function(){
        addForm.reset();
        clearErrors();
    });

    // Optional: live validation on blur
    sidInput.addEventListener('blur', ()=> { if(sidInput.value && !/^[0-9]+$/.test(sidInput.value)) sidError.textContent = "Student ID doit être numérique"; else sidError.textContent=""; });
    lnameInput.addEventListener('blur', ()=> { if(lnameInput.value && !/^[A-Za-zÀ-ÖØ-öø-ÿ'\- ]+$/.test(lnameInput.value)) lnameError.textContent = "Nom invalide"; else lnameError.textContent=""; });
    fnameInput.addEventListener('blur', ()=> { if(fnameInput.value && !/^[A-Za-zÀ-ÖØ-öø-ÿ'\- ]+$/.test(fnameInput.value)) fnameError.textContent = "Prénom invalide"; else fnameError.textContent=""; });
    emailInput.addEventListener('blur', ()=> { if(emailInput.value && !/^[^@\s]+@[^@\s]+\.[^@\s]+$/.test(emailInput.value)) emailError.textContent = "Email invalide"; else emailError.textContent=""; });

})();
</script>
</body>
</html>
