<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>TP AWP - Exo1 à 6</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<style>
    :root{ --beige:#F5ECE0; --marron:#6B4C3B; --accent:#B78A6D; --text:#3a2f2a; --muted:#7a6a60; --white:#fff; }
    body{ background: linear-gradient(180deg, var(--beige), #efe7db); color:var(--text); font-family: "Segoe UI", Roboto, Arial, sans-serif; padding:24px; }
    h1,h2{ color:var(--marron); margin-bottom:6px; }
    .container{ max-width:1100px; margin:0 auto; background:rgba(255,255,255,0.6); padding:18px; border-radius:12px; box-shadow:0 6px 18px rgba(107,76,59,0.12);}
    form{ display:flex; gap:12px; flex-wrap:wrap; align-items:end; margin-bottom:18px; }
    label{ font-size:14px; color:var(--marron); display:block; margin-bottom:4px;}
    input[type="text"], input[type="email"]{ padding:8px 10px; border-radius:6px; border:1px solid #d6c6bd; background:#fff; min-width:160px; }
    button{ background:var(--marron); color:var(--white); padding:8px 14px; border:none; border-radius:8px; cursor:pointer; box-shadow:0 2px 6px rgba(0,0,0,0.08); }
    button:disabled{ opacity:0.6; cursor:not-allowed; }
    .error{ color:#b00020; font-size:13px; margin-top:4px; min-height:16px;}
    table{ width:100%; border-collapse:collapse; margin-top:12px; font-size:14px; }
    th, td{ border:1px solid rgba(107,76,59,0.12); padding:6px 8px; text-align:center; vertical-align:middle; }
    th{ background:linear-gradient(90deg, rgba(183,138,109,0.15), rgba(183,138,109,0.05)); color:var(--marron); position:sticky; top:0; z-index:2;}
    .row-good{ background:linear-gradient(90deg, rgba(200,255,200,0.5), rgba(255,255,255,0)); }
    .row-warn{ background:linear-gradient(90deg, rgba(255,250,200,0.6), rgba(255,255,255,0)); }
    .row-bad{ background:linear-gradient(90deg, rgba(255,200,200,0.6), rgba(255,255,255,0)); }
    .small{ font-size:12px; color:var(--muted); }
    .controls{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .note{ margin-top:8px; font-size:13px; color:var(--muted); }
    .center{ text-align:center; }
    .checkbox-cell input{ transform:scale(1.1); }
    .highlight-row{ background-color:#c8ffc8 !important; }
    @media (max-width:980px){ table{ font-size:12px; } input[type="text"]{ min-width:120px; } }
</style>
</head>
<body>
<div class="container">
    <h1>TP AWP — Présences & Formulaire d'ajout</h1>
    <p class="small">Format : modèle <strong>B</strong> — 2 colonnes par session (P = Présence, Pa = Participation). Le formulaire valide ID, noms et email avant ajout.</p>

    <h2>Ajouter un étudiant</h2>
    <form id="addForm">
        <div>
            <label for="sid">Student ID</label>
            <input id="sid" name="sid" type="text" autocomplete="off">
            <div id="sidError" class="error"></div>
        </div>
        <div>
            <label for="lname">Last Name</label>
            <input id="lname" name="lname" type="text" autocomplete="off">
            <div id="lnameError" class="error"></div>
        </div>
        <div>
            <label for="fname">First Name</label>
            <input id="fname" name="fname" type="text" autocomplete="off">
            <div id="fnameError" class="error"></div>
        </div>
        <div>
            <label for="email">Email</label>
            <input id="email" name="email" type="email" autocomplete="off">
            <div id="emailError" class="error"></div>
        </div>
        <div class="controls">
            <button id="addBtn" type="submit">Add Student</button>
            <button id="resetBtn" type="button">Clear</button>
        </div>
    </form>

    <h2>Table d'assiduité</h2>
    <div style="overflow:auto">
    <table id="attendanceTable">
        <thead>
            <tr>
                <th rowspan="2">Student ID</th>
                <th rowspan="2">Last Name</th>
                <th rowspan="2">First Name</th>
                <th colspan="2">S1</th>
                <th colspan="2">S2</th>
                <th colspan="2">S3</th>
                <th colspan="2">S4</th>
                <th colspan="2">S5</th>
                <th colspan="2">S6</th>
                <th rowspan="2">Absences</th>
                <th rowspan="2">Participations</th>
                <th rowspan="2">Message</th>
                <th rowspan="2">Actions</th>
            </tr>
            <tr>
                <th>P</th><th>Pa</th>
                <th>P</th><th>Pa</th>
                <th>P</th><th>Pa</th>
                <th>P</th><th>Pa</th>
                <th>P</th><th>Pa</th>
                <th>P</th><th>Pa</th>
            </tr>
        </thead>
        <tbody id="tableBody">
            <!-- Les étudiants apparaîtront ici via JavaScript -->
        </tbody>
    </table>
    </div>

    <div style="margin-top:10px;">
        <button id="showReport">Show Report</button>
    </div>
    <div id="report" style="margin-top:10px; font-weight:bold;"></div>
    <canvas id="myChart" style="max-width:600px;margin-top:20px;"></canvas>

    <div style="margin-top:20px;">
        <button id="highlightExcellent">Highlight Excellent Students</button>
        <button id="resetColors">Reset Colors</button>
        <button onclick="window.location.href='list_students.php'">Voir les étudiants (BD)</button>
    </div>

    <p class="note">Astuce : coche/décoche les cases dans le tableau pour voir les calculs et la coloration s'appliquer en direct.</p>
</div>

<script>
// Version COMPLÈTE avec toutes les fonctionnalités
document.addEventListener('DOMContentLoaded', function() {
    const SESSIONS = 6;
    let uniqueCounter = 0;

    // Étudiants de démonstration
    const initialStudents = [
        { sid: "1001", lname: "Ahmed", fname: "Sara", presences: [1,1,0,0,1,0], parts: [1,0,0,0,1,0] },
        { sid: "1002", lname: "Yacine", fname: "Ali", presences: [1,0,1,1,1,1], parts: [1,0,1,1,1,1] },
        { sid: "1003", lname: "Houcine", fname: "Rania", presences: [1,1,0,1,1,0], parts: [1,0,0,1,0,0] }
    ];

    // Ajouter les étudiants initiaux
    initialStudents.forEach(student => addStudentToTable(student));

    // Gestion du formulaire
    document.getElementById('addForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const studentId = document.getElementById('sid').value.trim();
        const lastName = document.getElementById('lname').value.trim();
        const firstName = document.getElementById('fname').value.trim();
        const email = document.getElementById('email').value.trim();

        // Validation simple
        if (!studentId || !lastName || !firstName || !email) {
            alert('Tous les champs sont obligatoires');
            return;
        }

        // Préparer les données
        const payload = {
            student_id: studentId,
            last_name: lastName,
            first_name: firstName,
            email: email,
            group_id: "AWP"
        };

        // Envoyer vers PHP
        $.post('add_student.php', payload)
            .done(function(response) {
                alert(response);
                // Ajouter à la table
                addStudentToTable({
                    sid: studentId,
                    lname: lastName,
                    fname: firstName,
                    presences: [0,0,0,0,0,0],
                    parts: [0,0,0,0,0,0]
                });
                // Vider le formulaire
                document.getElementById('addForm').reset();
            })
            .fail(function() {
                alert('Erreur lors de l\'ajout');
            });
    });

    // Fonction pour ajouter un étudiant au tableau
    function addStudentToTable(student) {
        const tbody = document.getElementById('tableBody');
        const row = document.createElement('tr');
        
        // Informations de base
        row.innerHTML = `
            <td>${student.sid}</td>
            <td>${student.lname}</td>
            <td>${student.fname}</td>
        `;
        
        // Cases à cocher pour les sessions
        for (let i = 0; i < SESSIONS; i++) {
            row.innerHTML += `
                <td class="checkbox-cell"><input type="checkbox" ${student.presences[i] ? 'checked' : ''}></td>
                <td class="checkbox-cell"><input type="checkbox" ${student.parts[i] ? 'checked' : ''}></td>
            `;
        }
        
        // Colonnes calculées
        row.innerHTML += `
            <td class="absencesCell">0 Abs</td>
            <td class="partsCell">0 Par</td>
            <td class="msgCell">Good attendance - Participate more</td>
            <td><button class="delete-btn">Suppr</button></td>
        `;
        
        tbody.appendChild(row);
        
        // Bouton supprimer
        row.querySelector('.delete-btn').addEventListener('click', function() {
            row.remove();
        });
        
        // Mettre à jour les calculs
        updateRowCalculations(row);
        
        // Événements sur les checkbox
        row.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
            checkbox.addEventListener('change', () => updateRowCalculations(row));
        });
    }

    function updateRowCalculations(row) {
        const checkboxes = row.querySelectorAll('input[type="checkbox"]');
        let presenceCount = 0;
        let participationCount = 0;
        
        for (let i = 0; i < checkboxes.length; i += 2) {
            if (checkboxes[i].checked) presenceCount++;
            if (checkboxes[i + 1].checked) participationCount++;
        }
        
        const absences = SESSIONS - presenceCount;
        
        row.querySelector('.absencesCell').textContent = absences + ' Abs';
        row.querySelector('.partsCell').textContent = participationCount + ' Par';
        
        // Message et couleur
        let message = '';
        row.className = '';
        
        if (absences >= 5) {
            message = "Excluded - too many absences";
            row.classList.add('row-bad');
        } else if (absences >= 3) {
            message = "Warning - attendance low";
            row.classList.add('row-warn');
        } else {
            message = participationCount >= 4 ? 
                "Good attendance - Excellent participation" : 
                "Good attendance - Participate more";
            row.classList.add('row-good');
        }
        
        row.querySelector('.msgCell').textContent = message;
    }

    // Bouton Reset
    document.getElementById('resetBtn').addEventListener('click', function() {
        document.getElementById('addForm').reset();
    });
});

// DEUXIÈME SCRIPT - TOUTES LES FONCTIONNALITÉS JQUERY
$(document).ready(function() {
    
    // SHOW REPORT - Graphique
    $('#showReport').click(function() {
        const rows = $('#attendanceTable tbody tr');
        const totalStudents = rows.length;
        let totalPresent = 0;
        let totalParticipated = 0;
        
        rows.each(function() {
            const absText = $(this).find('.absencesCell').text();
            const abs = parseInt(absText) || 0;
            const presCount = 6 - abs;
            totalPresent += presCount;
            
            const partText = $(this).find('.partsCell').text();
            const partCount = parseInt(partText) || 0;
            totalParticipated += partCount;
        });
        
        $('#report').text(`Total Students: ${totalStudents}, Total Present: ${totalPresent}, Total Participated: ${totalParticipated}`);
        
        // Graphique
        const ctx = document.getElementById('myChart').getContext('2d');
        if (window.myChartInstance) {
            window.myChartInstance.destroy();
        }
        window.myChartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ['Total Students', 'Total Present', 'Total Participated'],
                datasets: [{
                    label: 'Attendance Report',
                    data: [totalStudents, totalPresent, totalParticipated],
                    backgroundColor: ['#6B4C3B', '#B78A6D', '#3a2f2a']
                }]
            }
        });
    });

    // HOVER sur les lignes
    $('#attendanceTable tbody').on('mouseenter', 'tr', function() {
        $(this).css('background-color', '#ffe7b3');
    });
    
    $('#attendanceTable tbody').on('mouseleave', 'tr', function() {
        $(this).css('background-color', '');
    });

    // CLICK sur une ligne
    $('#attendanceTable tbody').on('click', 'tr', function() {
        const name = $(this).find('td:nth-child(2)').text() + ' ' + $(this).find('td:nth-child(3)').text();
        const abs = $(this).find('.absencesCell').text();
        alert(`Student: ${name}\nAbsences: ${abs}`);
    });

    // HIGHLIGHT EXCELLENT STUDENTS
    $('#highlightExcellent').click(function() {
        $('#attendanceTable tbody tr').each(function() {
            const abs = parseInt($(this).find('.absencesCell').text()) || 0;
            if (abs < 3) {
                $(this).fadeOut(200).fadeIn(200).fadeOut(200).fadeIn(200);
            }
        });
    });

    // RESET COLORS
    $('#resetColors').click(function() {
        $('#attendanceTable tbody tr').css('background-color', '');
    });
});
</script>
</body>
</html>